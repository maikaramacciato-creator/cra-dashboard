<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>CRA Assistant</title>
<style>
.container {
  max-width: 960px;
  margin: 0 auto;
  padding: 20px;
  text-align: left;
}

.ready-button {
  width: auto;
  padding: 12px 24px;
  border-radius: 8px;
  background-color: #007bff;
  color: white;
  border: none;
  cursor: pointer;
}

.gear-icon {
  float: right;
  cursor: pointer;
  margin-left: 10px;
}

.cra-wellness-check {
  background: linear-gradient(to bottom, #2c3e50, #ecf0f1);
  padding: 20px;
  border-radius: 10px;
  color: #111;
}

.smart-assistant-link {
  text-decoration: underline;
  color: #007bff;
  font-weight: bold;
  cursor: pointer;
}

.toast {
  visibility: hidden;
  min-width: 250px;
  background-color: #333;
  color: white;
  text-align: center;
  padding: 16px;
  position: fixed;
  z-index: 1;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  border-radius: 8px;
}

.toast.show {
  visibility: visible;
  animation: fadein 0.5s, fadeout 0.5s 2.5s;
}

@keyframes fadein {
  from { opacity: 0; bottom: 20px; }
  to { opacity: 1; bottom: 30px; }
}

@keyframes fadeout {
  from { opacity: 1; bottom: 30px; }
  to { opacity: 0; bottom: 40px; }
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 25px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .dashboard-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .work-info {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
            font-size: 14px;
            color: #7f8c8d;
            flex-wrap: wrap;
        }
        
        .data-status {
            background: #e8f5e8;
            color: #2d6a2d;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .tab-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
            font-size: 13px;
        }
        
        .tab-button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .tab-button.active {
            background: #2c3e50;
            box-shadow: 0 3px 12px rgba(44, 62, 80, 0.4);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .content-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
        }
        
        .card-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .empty-state-message {
            font-size: 16px;
            line-height: 1.5;
        }
        
        .priority-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #3498db;
            display: block;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 13px;
            margin-top: 5px;
        }
        
        .task-list {
            margin-top: 20px;
        }
        
        .task-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 10px;
            border-left: 4px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .task-item.high-priority {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }
        
        .task-item.medium-priority {
            border-left-color: #f39c12;
            background: #fef9e7;
        }
        
        .task-item.low-priority {
            border-left-color: #27ae60;
            background: #eafaf1;
        }
        
        .task-content {
            flex: 1;
            min-width: 200px;
        }
        
        .task-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .task-details {
            font-size: 13px;
            color: #7f8c8d;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .task-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status-badge {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .status-todo {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-done {
            background: #d1e7dd;
            color: #0f5132;
        }
        
        .action-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .action-btn:hover {
            background: #219a52;
            transform: translateY(-1px);
        }
        
        .action-btn.secondary {
            background: #95a5a6;
        }
        
        .action-btn.secondary:hover {
            background: #7f8c8d;
        }
        
        .wellbeing-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .wellbeing-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .wellbeing-message {
            font-size: 14px;
            line-height: 1.5;
        }
        
        .site-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .site-info-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #3498db;
        }
        
        .info-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .info-value {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 600;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .info-value.editable:hover {
            background-color: #f8f9fa;
            border: 1px dashed #3498db;
        }
        
        .quick-add-task {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .quick-add-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .form-input {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-select {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .add-task-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .add-task-btn:hover {
            background: #219a52;
        }
        
        .time-display {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .work-hours-status {
            margin-left: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .work-hours-active {
            background: #d1e7dd;
            color: #0f5132;
        }
        
        .work-hours-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        @media (max-width: 768px) {
            .tabs {
                justify-content: flex-start;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .work-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .task-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .task-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
<div id="toast" class="toast">Action completed successfully</div>

<div class="container">
    <div class="dashboard-header">
        <h1>🏥 Enhanced CRA Management System v4</h1>
        <p id="site-header"><strong>Sites:</strong> None — add your sites using the button below</p>
        <div class="work-info">
            <span>🇸🇪 Based: Sweden</span>
            <span>🤝 Team: Finland</span>
            <span>🎯 Sponsor: Switzerland</span>
            <span class="time-display" id="current-time">⏰ Loading...</span>
            <span class="data-status" id="data-status">💾 Ready</span>
        </div>
        <div id="settings-panel" style="margin-top: 15px;">
            <details style="background: #ecf0f1; padding: 10px 15px; border-radius: 10px; cursor: pointer;">
                <summary style="font-weight: 600; color: #2c3e50;">
                    ⚙️ Customize Dashboard 
                    <span class="gear-icon">⚙️</span>
                </summary>

                <div style="margin-top: 10px;">
                    <label>Time Zone: <input class="form-input" id="timeZone" placeholder="Finland, USA, Europe/Stockholm" type="text"/></label><br/><br/>
                    <div style="font-size:12px; color:#7f8c8d; margin-top:5px; margin-bottom:10px;">
                        Supported time zones include: Finland (Europe/Helsinki), Sweden (Europe/Stockholm), Norway (Europe/Oslo), USA (America/New_York), UK (Europe/London), and Germany (Europe/Berlin). You may also enter any valid IANA time zone.
                    </div>
                    <label>CRA Country: <input class="form-input" id="craCountry" placeholder="Sweden" type="text"/></label><br/><br/>
                    <label>Team Country: <input class="form-input" id="teamCountry" placeholder="Finland" type="text"/></label><br/><br/>
                    <button class="ready-button" onclick="applySettings()">💾 Apply Settings</button>
                </div>
            </details>
        </div>
    </div>

    <div class="tabs" id="site-tabs">
        <button class="tab-button" onclick="addCustomSiteDynamic()" style="background:#2ecc71; font-weight:600;">➕ Add Site</button>
    </div>

    <!-- Smart Assistant -->
    <div class="content-card" id="smart-assistant" style="margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <span style="font-weight: 600; color: #2c3e50;">🤖 Smart CRA Assistant:</span>
            <input id="command-input" placeholder="Try: 'site 2302 next visit Sept 4', 'all sites newsletter filing'" style="flex: 1; min-width: 300px; padding: 8px 12px; border: 1px solid #bdc3c7; border-radius: 6px;" type="text"/>
            <button class="action-btn" onclick="processCommand()" style="background: #9b59b6;">🚀 Process</button>
            <button class="action-btn" onclick="resetData()" style="background: #e74c3c;">🔄 Reset</button>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">
            <strong>Real-time time zones!</strong> Auto-categorizes tasks by CRA requirements. Data saves automatically.
        </div>
    </div>

    <div class="tabs">
        <button class="tab-button active" onclick="showTab(event, 'priorities')">🎯 Priorities</button>
        <button class="tab-button" onclick="showTab(event, 'tasks')">📋 Tasks</button>
        <button class="tab-button" onclick="showTab(event, 'templates')">📑 Templates</button>
        <button class="tab-button" onclick="showTab(event, 'handover')">📤 Handover</button>
    </div>

    <!-- Wellbeing Card -->
    <div class="wellbeing-card">
        <div class="wellbeing-title">💚 CRA Wellness Check</div>
        <div class="wellbeing-message" id="wellbeing-message">
            Welcome to your clean, error‑free CRA workspace! Real‑time time zones and persistent data storage.
        </div>
        <!-- Mental health status will be updated dynamically based on workload -->
        <div id="mental-health-status" class="mental-health-status" style="margin-top:10px; font-size:14px; color:#34495e;"></div>
    </div>

    <!-- Priorities Tab -->
    <div class="tab-content active" id="priorities">
        <div class="content-card">
            <div class="card-title">🎯 Today's Priorities</div>
            <div class="priority-stats">
                <div class="stat-card">
                    <span class="stat-number" id="total-tasks">0</span>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="high-priority">0</span>
                    <div class="stat-label">High Priority</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="completed-tasks">0</span>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="this-week">0</span>
                    <div class="stat-label">This Week</div>
                </div>
            </div>
            <div class="task-list" id="priority-list">
                <div class="empty-state">
                    <div class="empty-state-icon">🎯</div>
                    <div class="empty-state-title">No High Priority Tasks</div>
                    <div class="empty-state-message">
                        Use the Smart Assistant at the top of the page or add tasks to see priorities here automatically.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks Tab -->
    <div class="tab-content" id="tasks">
        <div class="content-card">
            <div class="card-title">📋 Task Management</div>
            <div class="quick-add-task">
                <div class="quick-add-title">🚀 Quick Add Task</div>
                <div class="input-group">
                    <select class="form-select" id="task-site">
                        <option value="">Select Site</option>
                        <option value="all">🌐 All Sites</option>
                    </select>
                    <input class="form-input" id="task-description" placeholder="Task description" style="flex: 2;" type="text"/>
                    <input class="form-input" id="task-due-date" type="date"/>
                    <input class="form-input" id="task-time-spent" type="number" step="0.25" min="0" placeholder="Hrs spent" style="width:90px;"/>
                    <select class="form-select" id="task-category">
                        <option value="">Auto (Based on description)</option>
                        <option value="IMP Management">IMP Management</option>
                        <option value="Safety">Safety</option>
                        <option value="Regulatory">Regulatory</option>
                        <option value="Documentation">Documentation</option>
                        <option value="Monitoring">Monitoring</option>
                        <option value="Vendor Oversight">Vendor Oversight</option>
                        <option value="Data Integrity">Data Integrity</option>
                        <option value="Other">Other</option>
                    </select>
                    <select class="form-select" id="task-priority">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <button class="add-task-btn" onclick="addTask()">Add Task</button>
            </div>
            <div class="task-list" id="all-tasks">
                <div class="empty-state">
                    <div class="empty-state-icon">📋</div>
                    <div class="empty-state-title">No Tasks Yet</div>
                    <div class="empty-state-message">
                        Use the Smart CRA Assistant at the top of the page or the Quick Add form below to create your first task!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates Tab -->
    <div class="tab-content" id="templates">
        <div class="content-card">
            <div class="card-title">📑 Templates</div>
            <div>
                <div style="margin-bottom:10px; font-weight: 600;">Create New Template</div>
                <input id="template-name" class="form-input" placeholder="Template name" style="margin-bottom: 5px; width:100%;"/>
                <select id="template-type" class="form-select" style="margin-bottom: 5px;">
                    <option value="Email">Email</option>
                    <option value="Form">Form</option>
                    <option value="Other">Other</option>
                </select>
                <div style="font-size:13px; color:#7f8c8d; margin-bottom:5px;">
                    <strong>Template Types:</strong><br/>
                    <strong>Email</strong> – Ideal for recurring email messages (include subject and body).<br/>
                    <strong>Form</strong> – Use for structured documents or forms you need to fill repeatedly.<br/>
                    <strong>Other</strong> – Any other reusable text snippet (e.g., call notes or SOPs).
                </div>
                <textarea id="template-content" class="form-input" placeholder="Template content" style="margin-bottom: 5px; width:100%; height:100px;"></textarea>
                <button class="add-task-btn" id="save-template-btn" onclick="saveTemplate()">Save Template</button>
            </div>
            <div style="margin-top:20px;">
                <div style="margin-bottom: 10px; font-weight: 600;">Saved Templates</div>
                <div id="template-list" class="task-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">📑</div>
                        <div class="empty-state-title">No Templates Yet</div>
                        <div class="empty-state-message">
                            Create templates for emails, forms or other content. They will appear here.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Handover Tab -->
    <div class="tab-content" id="handover">
        <div class="content-card">
            <div class="card-title">📤 Handover</div>
            <div id="handover-content"></div>
            <button class="add-task-btn" id="generate-handover-btn" onclick="generateHandover()" style="display:none; margin-top:15px;">Generate Handover File</button>
        </div>
    </div>
</div>

<script>
// ===== GLOBAL VARIABLES =====
let currentTimeZone = 'Europe/Stockholm';
let siteData = {};
let taskCounter = 0;
let templatesData = [];

const timeZoneMap = {
    'finland': 'Europe/Helsinki',
    'sweden': 'Europe/Stockholm', 
    'norway': 'Europe/Oslo',
    'usa': 'America/New_York',
    'uk': 'Europe/London',
    'germany': 'Europe/Berlin'
};

// ===== UTILITY FUNCTIONS =====
function showToast(message) {
    try {
        const toast = document.getElementById('toast');
        if (toast) {
            toast.textContent = message;
            toast.className = 'toast show';
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
    } catch (error) {
        console.error('Toast error:', error);
    }
}

function scrollToSmartAssistant() {
    try {
        const smartAssistant = document.getElementById('smart-assistant');
        if (smartAssistant) {
            smartAssistant.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    } catch (error) {
        console.error('Scroll error:', error);
    }
}

// ===== TIME FUNCTIONS =====
function updateTime() {
    try {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { 
            timeZone: currentTimeZone,
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
        
        const hour = parseInt(now.toLocaleString('en-US', {
            timeZone: currentTimeZone,
            hour: 'numeric',
            hour12: false
        }));
        
        const isWorkHours = hour >= 8 && hour <= 16;
        
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
            timeElement.innerHTML = `⏰ ${timeString} <span class="work-hours-status ${isWorkHours ? 'work-hours-active' : 'work-hours-inactive'}">${isWorkHours ? 'Work Hours' : 'Off Hours'}</span>`;
        }
    } catch (error) {
        console.error('Time update error:', error);
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
            timeElement.textContent = '⏰ Time Error';
        }
    }
}

// ===== TAB FUNCTIONS =====
function showTab(event, tabId) {
    try {
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => {
            if (content) content.classList.remove('active');
        });
        
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
            if (button) button.classList.remove('active');
        });
        
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.classList.add('active');
        }
        
        if (event && event.target) {
            event.target.classList.add('active');
        }
        
        if (tabId === 'templates') {
            renderTemplates();
        } else if (tabId === 'handover') {
            renderHandover();
        }
        updateWellbeingMessage(tabId);
    } catch (error) {
        console.error('Tab switching error:', error);
        showToast('Error switching tabs');
    }
}

function updateWellbeingMessage(tabId) {
    try {
        const wellbeingMessage = document.getElementById('wellbeing-message');
        if (!wellbeingMessage) return;
        
        let message;
        if (tabId === 'priorities') {
            message = 'Focus on your top priorities! Clean interface with real-time time zones.';
        } else if (tabId === 'tasks') {
            message = 'Building your task system - everything saves automatically!';
        } else if (tabId && tabId.startsWith('site_')) {
            const siteNum = tabId.split('_')[1];
            message = `Site ${siteNum} ready for monitoring visits and task management.`;
        } else {
            message = 'Your clean CRA workspace is ready! Take breaks when needed.';
        }
        wellbeingMessage.textContent = message;
    } catch (error) {
        console.error('Wellbeing message update error:', error);
    }
}

// ===== TASK CLASSIFICATION =====
function classifyTask(description) {
    try {
        const categories = {
            "ecrf": "Data Integrity", "crf": "Data Integrity", "query": "Data Integrity", "queries": "Data Integrity",
            "data entry": "Data Integrity", "data review": "Data Integrity", "source data": "Data Integrity",
            "sdv": "Data Integrity", "data": "Data Integrity", "database": "Data Integrity", "sign": "Data Integrity",
            "review": "Data Integrity", "verify": "Data Integrity", "verification": "Data Integrity",
            "discrepancy": "Data Integrity", "pi to sign": "Data Integrity", "signature": "Data Integrity",
            
            "sae": "Safety", "ae": "Safety", "adverse event": "Safety", "susar": "Safety", "serious": "Safety",
            "safety": "Safety", "death": "Safety", "hospitalization": "Safety", "life threatening": "Safety",
            "medwatch": "Safety", "cioms": "Safety", "safety report": "Safety", "expedited": "Safety",
            
            "imp": "IMP Management", "ip": "IMP Management", "drug": "IMP Management", "product": "IMP Management",
            "shipment": "IMP Management", "shipping": "IMP Management", "temperature": "IMP Management",
            "inventory": "IMP Management", "accountability": "IMP Management", "dispense": "IMP Management",
            "dispensing": "IMP Management", "randomization": "IMP Management", "drug return": "IMP Management",
            "destruction": "IMP Management", "storage": "IMP Management",
            
            "ec": "Regulatory", "ethics": "Regulatory", "irb": "Regulatory", "submission": "Regulatory",
            "approval": "Regulatory", "regulatory": "Regulatory", "protocol deviation": "Regulatory",
            "deviation": "Regulatory", "amendment": "Regulatory", "protocol": "Regulatory", "consent": "Regulatory",
            "informed consent": "Regulatory", "icf": "Regulatory", "essential documents": "Regulatory",
            "tmf": "Regulatory", "authority": "Regulatory",
            
            "newsletter": "Documentation", "report": "Documentation", "filing": "Documentation",
            "document": "Documentation", "docs": "Documentation", "correspondence": "Documentation",
            "email": "Documentation", "minutes": "Documentation", "meeting": "Documentation",
            "communication": "Documentation", "letter": "Documentation", "memo": "Documentation",
            "update": "Documentation", "status": "Documentation", "cv": "Documentation", "training": "Documentation",
            "qualification": "Documentation", "ib": "Documentation", "investigator brochure": "Documentation",
            "gcp": "Documentation", "certification": "Documentation",
            
            "monitoring": "Monitoring", "visit": "Monitoring", "site visit": "Monitoring", "follow up": "Monitoring",
            "follow-up": "Monitoring", "monitoring plan": "Monitoring", "site management": "Monitoring",
            "pre study": "Monitoring", "initiation": "Monitoring", "close out": "Monitoring",
            "site training": "Monitoring", "investigator": "Monitoring", "coordinator": "Monitoring", "staff": "Monitoring",
            
            "vendor": "Vendor Oversight", "cro": "Vendor Oversight", "laboratory": "Vendor Oversight",
            "lab": "Vendor Oversight", "central lab": "Vendor Oversight", "supplier": "Vendor Oversight",
            "contract": "Vendor Oversight", "outsourced": "Vendor Oversight", "third party": "Vendor Oversight",
            "service provider": "Vendor Oversight"
        };

        const priorities = {
            "sae": "Urgent", "susar": "Urgent", "serious": "Urgent", "death": "Urgent",
            "life threatening": "Urgent", "hospitalization": "Urgent", "safety": "Urgent",
            "deviation": "Urgent", "protocol deviation": "Urgent", "expedited": "Urgent",
            
            "ecrf": "High", "crf": "High", "pi to sign": "High", "query": "High", "queries": "High",
            "sdv": "High", "source data": "High", "sign": "High", "verification": "High",
            "discrepancy": "High", "amendment": "High", "approval": "High", "consent": "High",
            
            "monitoring": "Medium", "visit": "Medium", "follow up": "Medium", "ib": "Medium",
            "cv": "Medium", "training": "Medium", "shipment": "Medium", "shipping": "Medium",
            "inventory": "Medium", "data": "Medium", "vendor": "Medium", "lab": "Medium", "meeting": "Medium",
            
            "newsletter": "Low", "report": "Low", "filing": "Low", "correspondence": "Low",
            "email": "Low", "minutes": "Low", "communication": "Low", "update": "Low", "status": "Low"
        };

        let matchedCategory = "Other";
        let matchedPriority = "Low";
        const input = description.toLowerCase();
        
        // Check for exact phrase matches first
        const phrasePatterns = [
            "pi to sign", "follow up", "follow-up", "data entry", "data review", "source data",
            "adverse event", "protocol deviation", "drug return", "site visit", "central lab",
            "third party", "life threatening", "informed consent", "essential documents",
            "investigator brochure", "site training", "close out", "pre study"
        ];
        
        for (const phrase of phrasePatterns) {
            if (input.includes(phrase)) {
                if (categories[phrase]) {
                    matchedCategory = categories[phrase];
                    if (priorities[phrase]) {
                        matchedPriority = priorities[phrase];
                    }
                    return { category: matchedCategory, priority: matchedPriority };
                }
            }
        }
        
        // Then check for individual word matches
        for (const keyword in categories) {
            if (keyword.includes(' ')) continue;
            
            const pattern = '\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\            "imp": "IMP Management", "ip":') + '\\b';
            const regex = new RegExp(pattern, 'i');
            if (regex.test(input)) {
                matchedCategory = categories[keyword];
                if (priorities[keyword]) {
                    matchedPriority = priorities[keyword];
                }
                break;
            }
        }
        
        return { category: matchedCategory, priority: matchedPriority };
    } catch (error) {
        console.error('Classification error:', error);
        return { category: "Other", priority: "Low" };
    }
}

// ===== TASK MANAGEMENT FUNCTIONS =====
function addTask() {
    try {
        const site = document.getElementById('task-site')?.value || '';
        const description = document.getElementById('task-description')?.value || '';
        const dueDate = document.getElementById('task-due-date')?.value || '';
        const priority = document.getElementById('task-priority')?.value || 'low';
        const selectedCategory = document.getElementById('task-category')?.value || '';
        
        if (!site || !description) {
            showToast("Please select a site and enter a description");
            return;
        }
        
        taskCounter++;
        const taskId = 'task_' + Date.now() + '_' + taskCounter;
        
        const classification = classifyTask(description);
        let timeSpent = 0;
        const timeInputEl = document.getElementById('task-time-spent');
        if (timeInputEl && timeInputEl.value) {
            const parsed = parseFloat(timeInputEl.value);
            timeSpent = isNaN(parsed) ? 0 : parsed;
        }
        
        const finalCategory = selectedCategory || classification.category || 'General';
        const taskObject = {
            id: taskId,
            site: site,
            description: description,
            dueDate: dueDate,
            priority: priority,
            category: finalCategory,
            timeSpent: timeSpent,
            status: 'todo',
            created: new Date().toISOString()
        };
        
        if (site === 'all') {
            const allSites = Object.keys(siteData);
            if (allSites.length === 0) {
                showToast('⚠️ No sites available. Please add a site first.');
                return;
            }
            allSites.forEach(siteNumber => {
                ensureSiteExists(siteNumber);
                const clonedTask = { ...taskObject, id: taskObject.id + '_' + siteNumber, site: siteNumber };
                siteData[siteNumber].tasks.push(clonedTask);
                addToTaskList(clonedTask, siteNumber);
                addToSiteTaskList(clonedTask, siteNumber);
            });
            showToast('✅ Task added to all sites!');
        } else {
            ensureSiteExists(site);
            siteData[site].tasks.push(taskObject);
            addToTaskList(taskObject, site);
            addToSiteTaskList(taskObject, site);
            showToast('✅ Task added successfully!');
        }
        
        // Clear form
        ['task-site', 'task-description', 'task-due-date', 'task-category', 'task-time-spent'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.value = '';
        });
        const priorityEl = document.getElementById('task-priority');
        if (priorityEl) priorityEl.value = 'low';
        
        updateTaskStats();
        saveData();
    } catch (error) {
        console.error('Add task error:', error);
        showToast('Error adding task');
    }
}

function addToTaskList(task, displaySite) {
    try {
        const taskList = document.getElementById('all-tasks');
        if (!taskList) return;
        
        const emptyState = taskList.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }
        
        const siteDisplay = displaySite === 'all' ? 'All Sites' : `Site ${task.site}`;
        const priorityLabel = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
        const categoryLabel = task.category || 'General';
        
        const taskItem = document.createElement('div');
        taskItem.className = `task-item ${task.priority}-priority`;
        taskItem.setAttribute('data-task-id', task.id);
        if (task.site) {
            taskItem.setAttribute('data-site', task.site);
        }
        
        taskItem.innerHTML = `
            <div class="task-content">
                <div class="task-title">${siteDisplay} - ${task.description}</div>
                <div class="task-details">
                    <span>📂 Category: ${categoryLabel}</span>
                    <span>📅 Due: ${task.dueDate || 'No deadline'}</span>
                    <span>⏱️ Time: ${task.timeSpent && task.timeSpent > 0 ? task.timeSpent + 'h' : 'N/A'}</span>
                    <span>⚠️ Priority: ${priorityLabel}</span>
                </div>
            </div>
            <div class="task-actions">
                <span class="status-badge status-todo">To Do</span>
                <button class="action-btn" onclick="markDone(this)">Mark Done</button>
                <button class="action-btn" style="background:#2980b9;" onclick="editTask(this)">Edit</button>
                <button class="action-btn" style="background:#e74c3c;" onclick="deleteTask(this)">Delete</button>
            </div>
        `;
        
        if (task.priority === 'high') {
            taskList.insertBefore(taskItem, taskList.firstChild);
        } else {
            taskList.appendChild(taskItem);
        }
    } catch (error) {
        console.error('Add to task list error:', error);
    }
}

function markDone(button) {
    try {
        const taskItem = button.closest('.task-item');
        if (!taskItem) return;
        
        const taskId = taskItem.getAttribute('data-task-id');
        
        const statusBadge = taskItem.querySelector('.status-badge');
        if (statusBadge) {
            statusBadge.textContent = 'Done';
            statusBadge.className = 'status-badge status-done';
        }
        
        button.textContent = '✅ Done';
        button.disabled = true;
        button.style.background = '#95a5a6';
        
        Object.values(siteData).forEach(site => {
            if (site.tasks) {
                const task = site.tasks.find(t => t.id === taskId);
                if (task) {
                    task.status = 'done';
                }
            }
        });
        
        updateTaskStats();
        saveData();
        showToast('✅ Task completed!');
    } catch (error) {
        console.error('Mark done error:', error);
        showToast('Error marking task as done');
    }
}

function deleteTask(button) {
    try {
        const taskItem = button.closest('.task-item');
        if (!taskItem) return;
        
        const taskTitle = taskItem.querySelector('.task-title')?.textContent || 'Unknown task';
        
        if (confirm(`⚠️ Delete task: "${taskTitle}"?`)) {
            const taskId = taskItem.getAttribute('data-task-id');
            
            Object.values(siteData).forEach(site => {
                if (site.tasks) {
                    site.tasks = site.tasks.filter(t => t.id !== taskId);
                }
            });
            
            taskItem.remove();
            
            const taskList = document.getElementById('all-tasks');
            if (taskList && taskList.children.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <div class="empty-state-title">No Tasks Yet</div>
                        <div class="empty-state-message">
                            Use the Smart CRA Assistant at the top of the page or the Quick Add form below to create your first task!
                        </div>
                    </div>
                `;
            }
            
            updateTaskStats();
            saveData();
            showToast('✅ Task deleted!');
        }
    } catch (error) {
        console.error('Delete task error:', error);
        showToast('Error deleting task');
    }
}

function editTask(button) {
    try {
        const taskItem = button.closest('.task-item');
        if (!taskItem) return;
        
        const taskId = taskItem.getAttribute('data-task-id');
        let foundTask = null;
        
        for (const site in siteData) {
            if (siteData[site].tasks) {
                foundTask = siteData[site].tasks.find(t => t.id === taskId);
                if (foundTask) break;
            }
        }
        
        if (!foundTask) {
            showToast('Task not found.');
            return;
        }
        
        const newDesc = prompt('Edit task description:', foundTask.description);
        if (newDesc === null) return;
        
        const newDue = prompt('Edit due date (YYYY-MM-DD) or leave blank:', foundTask.dueDate || '');
        let newPriority = prompt('Edit priority (low, medium, high):', foundTask.priority) || foundTask.priority;
        newPriority = newPriority.toLowerCase();
        if (!['low','medium','high'].includes(newPriority)) {
            newPriority = foundTask.priority;
        }
        
        let newTimeSpentInput = prompt('Edit time spent (hours, e.g., 0.5, 1, 0.75):', foundTask.timeSpent !== undefined ? foundTask.timeSpent : '');
        let newTimeSpent = foundTask.timeSpent || 0;
        if (newTimeSpentInput !== null && newTimeSpentInput.trim() !== '') {
            const parsedTime = parseFloat(newTimeSpentInput.trim());
            if (!isNaN(parsedTime)) {
                newTimeSpent = parsedTime;
            }
        }
        
        const categoryPrompt = 'Edit category (IMP Management, Safety, Regulatory, Documentation, Monitoring, Vendor Oversight, Data Integrity, Other):';
        let newCategory = prompt(categoryPrompt, foundTask.category) || foundTask.category;
        
        foundTask.description = newDesc.trim();
        foundTask.dueDate = newDue ? newDue.trim() : '';
        foundTask.priority = newPriority;
        foundTask.timeSpent = newTimeSpent;
        
        const reClass = classifyTask(foundTask.description);
        if (newCategory) {
            foundTask.category = newCategory.trim();
        } else {
            foundTask.category = reClass.category || foundTask.category;
        }
        
        const taskTitleEl = taskItem.querySelector('.task-title');
        if (taskTitleEl) {
            const isGlobal = taskItem.closest('#all-tasks') !== null;
            if (isGlobal) {
                const siteDisplay = foundTask.site === 'all' ? 'All Sites' : `Site ${foundTask.site}`;
                taskTitleEl.textContent = `${siteDisplay} - ${foundTask.description}`;
            } else {
                taskTitleEl.textContent = foundTask.description;
            }
        }
        
        const details = taskItem.querySelector('.task-details');
        if (details) {
            const priorityLabel = foundTask.priority.charAt(0).toUpperCase() + foundTask.priority.slice(1);
            const categoryLabel = foundTask.category || 'General';
            const timeLabel = (foundTask.timeSpent && foundTask.timeSpent > 0) ? `${foundTask.timeSpent}h` : 'N/A';
            details.innerHTML = `<span>📂 Category: ${categoryLabel}</span><span>📅 Due: ${foundTask.dueDate || 'No deadline'}</span><span>⏱️ Time: ${timeLabel}</span><span>⚠️ Priority: ${priorityLabel}</span>`;
        }
        
        taskItem.className = `task-item ${foundTask.priority}-priority`;
        updateTaskStats();
        saveData();
        showToast('✅ Task updated!');
    } catch (error) {
        console.error('Edit task error:', error);
        showToast('Error editing task');
    }
}

function updateTaskStats() {
    try {
        const allTasks = [];
        Object.values(siteData).forEach(site => {
            if (site.tasks && Array.isArray(site.tasks)) {
                allTasks.push(...site.tasks);
            }
        });
        
        const totalTasks = allTasks.length;
        const highPriority = allTasks.filter(t => t.priority === 'high').length;
        const completed = allTasks.filter(t => t.status === 'done').length;
        const thisWeek = totalTasks;
        
        const elements = {
            'total-tasks': totalTasks,
            'high-priority': highPriority,
            'completed-tasks': completed,
            'this-week': thisWeek
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        });
        
        Object.keys(siteData).forEach(site => {
            const siteTaskCount = siteData[site].tasks ? siteData[site].tasks.filter(t => t.status !== 'done').length : 0;
            const dynamicElement = document.getElementById(`site_${site}-tasks`);
            if (dynamicElement) {
                dynamicElement.textContent = siteTaskCount;
            }
        });
        
        const priorityList = document.getElementById('priority-list');
        if (priorityList) {
            const highPriorityTasks = allTasks.filter(t => t.priority === 'high' && t.status !== 'done');
            
            if (highPriorityTasks.length > 0) {
                priorityList.innerHTML = '';
                highPriorityTasks.forEach(task => {
                    const taskDiv = document.createElement('div');
                    taskDiv.className = 'task-item high-priority';
                    taskDiv.innerHTML = `
                        <div class="task-content">
                            <div class="task-title">Site ${task.site} - ${task.description}</div>
                            <div class="task-details">
                                <span>📅 Due: ${task.dueDate || 'No deadline'}</span>
                                <span>⚠️ Priority: High</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <span class="status-badge status-todo">High Priority</span>
                        </div>
                    `;
                    priorityList.appendChild(taskDiv);
                });
            } else if (totalTasks > 0) {
                priorityList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🎯</div>
                        <div class="empty-state-title">No High Priority Tasks</div>
                        <div class="empty-state-message">
                            All tasks are under control! High priority items will appear here.
                        </div>
                    </div>
                `;
            }
        }
        
        renderHandover();
        updateMentalHealthStatus();
    } catch (error) {
        console.error('Update task stats error:', error);
    }
}

// ===== SITE MANAGEMENT FUNCTIONS =====
function ensureSiteExists(siteNumber) {
    try {
        if (!siteNumber) return;
        if (!siteData[siteNumber]) {
            siteData[siteNumber] = { tasks: [], lastVisit: null, nextVisit: null };
        }
        createSiteTabDynamic(siteNumber);
        createSiteTabContent(siteNumber);
        addSiteOption(siteNumber);
    } catch (error) {
        console.error('Error ensuring site exists:', error);
    }
}

function createSiteTabDynamic(siteNumber) {
    try {
        const siteTabs = document.getElementById('site-tabs');
        if (!siteTabs) return;
        if (siteTabs.querySelector(`button[data-site='${siteNumber}']`)) return;
        
        const tab = document.createElement('button');
        tab.className = 'tab-button';
        tab.setAttribute('data-site', siteNumber);
        tab.textContent = `Site ${siteNumber}`;
        tab.onclick = function(event) {
            showTab(event, 'site_' + siteNumber);
        };
        
        const delBtn = document.createElement('span');
        delBtn.textContent = ' ❌';
        delBtn.style.marginLeft = '8px';
        delBtn.style.color = '#e74c3c';
        delBtn.style.cursor = 'pointer';
        delBtn.onclick = function(e) {
            e.stopPropagation();
            deleteSite(siteNumber, tab);
        };
        tab.appendChild(delBtn);
        siteTabs.appendChild(tab);
    } catch (error) {
        console.error('Error creating site tab:', error);
    }
}

function deleteSite(siteNumber, tabElement) {
    try {
        delete siteData[siteNumber];
        
        const page = document.getElementById('site_' + siteNumber);
        if (page) page.remove();
        if (tabElement) tabElement.remove();
        
        const select = document.getElementById('task-site');
        const opt = select ? select.querySelector(`option[value='${siteNumber}']`) : null;
        if (opt) opt.remove();
        
        const allTasksList = document.getElementById('all-tasks');
        if (allTasksList) {
            Array.from(allTasksList.querySelectorAll('.task-item')).forEach(item => {
                const itemSite = item.getAttribute('data-site');
                if (itemSite === siteNumber) {
                    item.remove();
                }
            });
            
            if (allTasksList.children.length === 0) {
                allTasksList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <div class="empty-state-title">No Tasks Yet</div>
                        <div class="empty-state-message">
                            Use the Smart CRA Assistant at the top of the page or the Quick Add form below to create your first task!
                        </div>
                    </div>
                `;
            }
        }
        updateTaskStats();
        saveData();
        showToast('✅ Site deleted successfully!');
    } catch (error) {
        console.error('Error deleting site:', error);
        showToast('Error deleting site');
    }
}

function createSiteTabContent(siteNumber) {
    try {
        const tasksTab = document.getElementById('tasks');
        if (!tasksTab) return;
        const parent = tasksTab.parentNode;
        if (document.getElementById('site_' + siteNumber)) return;
        
        const content = document.createElement('div');
        content.className = 'tab-content';
        content.id = 'site_' + siteNumber;
        content.innerHTML = `
            <div class="content-card">
                <div class="card-title">🏥 Site ${siteNumber} Overview</div>
                <div class="site-info-grid">
                    <div class="site-info-item">
                        <div class="info-label">Last Visit</div>
                        <div class="info-value editable" id="site_${siteNumber}-lastVisit" onclick="editVisit('${siteNumber}', 'last')">Click to set</div>
                    </div>
                    <div class="site-info-item">
                        <div class="info-label">Next Visit</div>
                        <div class="info-value editable" id="site_${siteNumber}-nextVisit" onclick="editVisit('${siteNumber}', 'next')">Click to set</div>
                    </div>
                    <div class="site-info-item">
                        <div class="info-label">Open Tasks</div>
                        <div class="info-value" id="site_${siteNumber}-tasks">0</div>
                    </div>
                </div>
                <div class="task-list" id="site_${siteNumber}-task-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <div class="empty-state-title">No Tasks for Site ${siteNumber}</div>
                        <div class="empty-state-message">
                            Use the task form to add tasks to this site.
                        </div>
                    </div>
                </div>
            </div>
        `;
        parent.appendChild(content);
        
        const lastVal = siteData[siteNumber] && siteData[siteNumber].lastVisit ? siteData[siteNumber].lastVisit : null;
        const nextVal = siteData[siteNumber] && siteData[siteNumber].nextVisit ? siteData[siteNumber].nextVisit : null;
        updateSiteVisitDisplay(siteNumber, 'last', lastVal || 'Click to set');
        updateSiteVisitDisplay(siteNumber, 'next', nextVal || 'Click to set');
    } catch (error) {
        console.error('Error creating site content:', error);
    }
}

function addSiteOption(siteNumber) {
    try {
        const select = document.getElementById('task-site');
        if (!select) return;
        if (select.querySelector(`option[value='${siteNumber}']`)) return;
        const option = document.createElement('option');
        option.value = siteNumber;
        option.textContent = `Site ${siteNumber}`;
        select.appendChild(option);
    } catch (error) {
        console.error('Error adding site option:', error);
    }
}

function addToSiteTaskList(task, siteNumber) {
    try {
        const list = document.getElementById(`site_${siteNumber}-task-list`);
        if (!list) return;
        const emptyState = list.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }
        const priorityLabel = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
        const categoryLabel = task.category || 'General';
        const item = document.createElement('div');
        item.className = `task-item ${task.priority}-priority`;
        item.setAttribute('data-task-id', task.id);
        item.setAttribute('data-site', siteNumber);
        item.innerHTML = `
            <div class="task-content">
                <div class="task-title">${task.description}</div>
                <div class="task-details">
                    <span>📂 Category: ${categoryLabel}</span>
                    <span>📅 Due: ${task.dueDate || 'No deadline'}</span>
                    <span>⏱️ Time: ${task.timeSpent && task.timeSpent > 0 ? task.timeSpent + 'h' : 'N/A'}</span>
                    <span>⚠️ Priority: ${priorityLabel}</span>
                </div>
            </div>
            <div class="task-actions">
                <span class="status-badge status-todo">To Do</span>
                <button class="action-btn" onclick="markDone(this)">Mark Done</button>
                <button class="action-btn" style="background:#2980b9;" onclick="editTask(this)">Edit</button>
                <button class="action-btn" style="background:#e74c3c;" onclick="deleteTask(this)">Delete</button>
            </div>
        `;
        if (task.priority === 'high') {
            list.insertBefore(item, list.firstChild);
        } else {
            list.appendChild(item);
        }
    } catch (error) {
        console.error('Error adding task to site list:', error);
    }
}

function addCustomSiteDynamic() {
    try {
        const input = prompt('Enter site number (e.g., 2312):');
        if (!input) return;
        const siteNumber = input.trim();
        if (siteData[siteNumber]) {
            showToast('⚠️ Site already exists.');
            return;
        }
        ensureSiteExists(siteNumber);
        saveData();
        showToast(`✅ Site ${siteNumber} added!`);
    } catch (error) {
        console.error('Error adding site:', error);
        showToast('Error adding site');
    }
}

function editVisit(site, type) {
    try {
        const field = type + 'Visit';
        const current = siteData[site] && siteData[site][field] ? siteData[site][field] : 'Not set';
        
        const newDate = prompt(`Edit ${type} visit for Site ${site}:\n\nCurrent: ${current}\n\nEnter new date (YYYY-MM-DD) or leave blank to clear:`);
        
        if (newDate === null) return;
        
        if (newDate.trim() === '') {
            siteData[site][field] = null;
            updateSiteVisitDisplay(site, type, 'Click to set');
        } else {
            siteData[site][field] = newDate;
            updateSiteVisitDisplay(site, type, newDate);
        }
        
        saveData();
        showToast(`✅ ${type} visit updated for Site ${site}`);
    } catch (error) {
        console.error('Error editing visit:', error);
        showToast('Error updating visit date');
    }
}

function updateSiteVisitDisplay(site, type, value) {
    try {
        const fieldId = `site_${site}-${type}Visit`;
        const el = document.getElementById(fieldId);
        if (el) {
            el.textContent = value && value !== '' ? value : 'Click to set';
        }
    } catch (error) {
        console.error('Error updating site visit display:', error);
    }
}

function setVisitDate(site, type, date) {
    try {
        if (!site) return;
        const field = type + 'Visit';
        ensureSiteExists(site);
        if (!date || date.trim() === '') {
            siteData[site][field] = null;
            updateSiteVisitDisplay(site, type, 'Click to set');
        } else {
            siteData[site][field] = date;
            updateSiteVisitDisplay(site, type, date);
        }
        saveData();
    } catch (error) {
        console.error('Error setting visit date:', error);
    }
}

function initializeSites() {
    try {
        const sites = Object.keys(siteData);
        sites.forEach(siteNumber => {
            ensureSiteExists(siteNumber);
        });
    } catch (error) {
        console.error('Error initializing sites:', error);
    }
}

function removeLegacySiteElements() {
    try {
        document.querySelectorAll('.tab-button').forEach(btn => {
            const label = btn.textContent.trim();
            if (btn.getAttribute('data-site')) return;
            if (/^Site\s?\d{4}$/.test(label)) {
                btn.remove();
            }
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            const id = content.id || '';
            if (/^site\d{4}$/.test(id)) {
                content.remove();
            }
        });
    } catch (error) {
        console.error('Error removing legacy elements:', error);
    }
}

// ===== SMART ASSISTANT FUNCTIONS =====
function processCommand() {
    try {
        const input = document.getElementById('command-input');
        if (!input) return;
        
        const command = input.value.trim();
        if (!command) {
            showToast('Please enter a command first.');
            return;
        }

        const visitRegex = /(\d{4}).*\b(next visit|last visit)\b/;
        const visitMatch = command.toLowerCase().match(visitRegex);
        if (visitMatch) {
            const site = visitMatch[1];
            const isNext = visitMatch[2] === 'next visit';
            const dateMatch = command.match(/\b\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}\b|\b\d{4}-\d{2}-\d{2}\b/);
            const dateString = dateMatch ? dateMatch[0] : null;
            if (!dateString) {
                showToast('Could not find a valid date in the command.');
                return;
            }
            const date = new Date(dateString);
            if (isNaN(date)) {
                showToast('Invalid date format. Please use a valid date.');
                return;
            }
            const formattedDate = date.toISOString().split('T')[0];
            ensureSiteExists(site);
            setVisitDate(site, isNext ? 'next' : 'last', formattedDate);
            showToast(`✅ ${isNext ? 'Next' : 'Last'} visit set for Site ${site}: ${formattedDate}`);
            input.value = '';
            return;
        }

        const siteExtract = command.match(/\b(\d{4})\b/);
        if (!siteExtract) {
            showToast('Please specify a 4‑digit site number in your command.');
            return;
        }
        const siteNumber = siteExtract[1];
        
        let description = command.replace(new RegExp('\\bsite\\s*' + siteNumber + '\\b', 'i'), '').trim();
        description = description.replace(new RegExp('\\b' + siteNumber + '\\b', 'i'), '').trim();
        if (!description) {
            showToast('Please include a task description after the site number.');
            return;
        }
        ensureSiteExists(siteNumber);
        
        const { category, priority } = classifyTask(description);
        let suggestedPriority = 'low';
        if (priority.toLowerCase() === 'urgent') suggestedPriority = 'high';
        else if (priority.toLowerCase() === 'medium') suggestedPriority = 'medium';
        
        const accept = confirm(
            `Detected Category: ${category}\nSuggested Priority: ${priority}\n\nSite: ${siteNumber}\nTask: ${description}\n\nClick OK to accept and create this task, or Cancel to edit the details.`
        );
        
        if (accept) {
            const siteEl = document.getElementById('task-site');
            const descEl = document.getElementById('task-description');
            const priorityEl = document.getElementById('task-priority');
            const dueDateEl = document.getElementById('task-due-date');
            
            if (siteEl) siteEl.value = siteNumber;
            if (descEl) descEl.value = description;
            if (priorityEl) priorityEl.value = suggestedPriority;
            if (dueDateEl) dueDateEl.value = '';
            
            addTask();
        } else {
            const newSite = prompt('Enter site number:', siteNumber) || siteNumber;
            const newDesc = prompt('Enter task description:', description) || description;
            const newDue = prompt('Enter due date (YYYY-MM-DD) or leave blank:', '');
            let newPriority = prompt('Enter priority (low, medium, high):', suggestedPriority) || suggestedPriority;
            newPriority = newPriority.toLowerCase();
            if (!['low','medium','high'].includes(newPriority)) newPriority = suggestedPriority;
            
            const siteEl = document.getElementById('task-site');
            const descEl = document.getElementById('task-description');
            const priorityEl = document.getElementById('task-priority');
            const dueDateEl = document.getElementById('task-due-date');
            
            if (siteEl) siteEl.value = newSite.trim();
            if (descEl) descEl.value = newDesc.trim();
            if (priorityEl) priorityEl.value = newPriority;
            if (dueDateEl) dueDateEl.value = newDue ? newDue.trim() : '';
            
            addTask();
        }
        input.value = '';
    } catch (error) {
        console.error('Error processing command:', error);
        showToast('Error processing command');
    }
}

// ===== SETTINGS FUNCTIONS =====
function applySettings() {
    try {
        const timeZoneEl = document.getElementById('timeZone');
        const craCountryEl = document.getElementById('craCountry');
        const teamCountryEl = document.getElementById('teamCountry');
        
        const timeZone = timeZoneEl ? timeZoneEl.value.trim().toLowerCase() : '';
        const craCountry = craCountryEl ? craCountryEl.value || 'Sweden' : 'Sweden';
        const teamCountry = teamCountryEl ? teamCountryEl.value || 'Finland' : 'Finland';
        
        if (timeZone) {
            currentTimeZone = timeZoneMap[timeZone] || timeZone;
            updateTime();
        }
        
        const workInfo = document.querySelector('.work-info');
        if (workInfo) {
            workInfo.innerHTML = `
                <span>🇸🇪 Based: ${craCountry}</span>
                <span>🤝 Team: ${teamCountry}</span>
                <span>🎯 Sponsor: Switzerland</span>
                <span class="time-display" id="current-time">⏰ Loading...</span>
                <span class="data-status" id="data-status">💾 Updated</span>
            `;
        }
        
        updateTime();
        saveData();
        showToast(`✅ Settings updated! Time Zone: ${currentTimeZone}, CRA: ${craCountry}, Team: ${teamCountry}`);
    } catch (error) {
        console.error('Error applying settings:', error);
        showToast('Error updating settings');
    }
}

function resetData() {
    try {
        if (confirm('⚠️ Reset all data? This cannot be undone.')) {
            siteData = {};
            taskCounter = 0;
            templatesData = [];
            
            const siteTabs = document.getElementById('site-tabs');
            if (siteTabs) {
                Array.from(siteTabs.children).forEach(btn => {
                    const isAddButton = btn.getAttribute('onclick') && btn.getAttribute('onclick').includes('addCustomSiteDynamic');
                    if (!isAddButton) {
                        btn.remove();
                    }
                });
            }
            
            document.querySelectorAll('.tab-content').forEach(content => {
                if (content.id && content.id.startsWith('site_')) {
                    content.remove();
                }
            });
            
            const select = document.getElementById('task-site');
            if (select) {
                Array.from(select.options).forEach(opt => {
                    if (opt.value !== '' && opt.value !== 'all') {
                        opt.remove();
                    }
                });
            }
            
            const allTasksEl = document.getElementById('all-tasks');
            if (allTasksEl) {
                allTasksEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <div class="empty-state-title">No Tasks Yet</div>
                        <div class="empty-state-message">
                            Use the Smart CRA Assistant at the top of the page or the Quick Add form below to create your first task!
                        </div>
                    </div>
                `;
            }
            
            updateTaskStats();
            renderTemplates();
            renderHandover();
            updateMentalHealthStatus();
            saveData();
            showToast('✅ All data reset successfully!');
        }
    } catch (error) {
        console.error('Error resetting data:', error);
        showToast('Error resetting data');
    }
}

// ===== DATA PERSISTENCE FUNCTIONS =====
function saveData() {
    try {
        const dataToSave = {
            siteData: siteData,
            taskCounter: taskCounter,
            templatesData: templatesData,
            currentTimeZone: currentTimeZone,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('craSystemData', JSON.stringify(dataToSave));
        
        const statusElement = document.getElementById('data-status');
        if (statusElement) {
            statusElement.textContent = '💾 Saved';
            setTimeout(() => {
                statusElement.textContent = '💾 Ready';
            }, 2000);
        }
    } catch (error) {
        console.error('Save error:', error);
    }
}

function loadData() {
    try {
        const savedData = localStorage.getItem('craSystemData');
        if (savedData) {
            const data = JSON.parse(savedData);
            siteData = data.siteData || {};
            taskCounter = data.taskCounter || 0;
            templatesData = data.templatesData || [];
            currentTimeZone = data.currentTimeZone || 'Europe/Stockholm';
        }
    } catch (error) {
        console.error('Load error:', error);
    }
}

// ===== TEMPLATE FUNCTIONS =====
function renderTemplates() {
    try {
        const container = document.getElementById('template-list');
        if (!container) return;
        container.innerHTML = '';
        
        if (!Array.isArray(templatesData) || templatesData.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">📑</div>
                    <div class="empty-state-title">No Templates Yet</div>
                    <div class="empty-state-message">
                        Create templates for emails, forms or other content. They will appear here.
                    </div>
                </div>
            `;
            return;
        }
        
        templatesData.forEach(tmpl => {
            const item = document.createElement('div');
            item.className = 'task-item low-priority';
            item.setAttribute('data-template-id', tmpl.id);
            item.innerHTML = `
                <div class="task-content">
                    <div class="task-title">${tmpl.name} (${tmpl.type})</div>
                    <div class="task-details"><span>${tmpl.content.substring(0, 80)}${tmpl.content.length > 80 ? '…' : ''}</span></div>
                </div>
                <div class="task-actions">
                    <button class="action-btn" style="background:#27ae60;" onclick="useTemplate('${tmpl.id}')">Use</button>
                    <button class="action-btn" style="background:#e74c3c;" onclick="deleteTemplate('${tmpl.id}')">Delete</button>
                </div>
            `;
            container.appendChild(item);
        });
    } catch (error) {
        console.error('Render templates error:', error);
    }
}

function saveTemplate() {
    try {
        const nameInput = document.getElementById('template-name');
        const typeSelect = document.getElementById('template-type');
        const contentArea = document.getElementById('template-content');
        
        if (!nameInput || !typeSelect || !contentArea) {
            showToast('Template form elements not found.');
            return;
        }
        
        const name = nameInput.value.trim();
        const type = typeSelect.value;
        const content = contentArea.value.trim();
        
        if (!name || !content) {
            showToast('Please enter a template name and content.');
            return;
        }
        
        const id = 'tmpl_' + Date.now();
        templatesData.push({ id: id, name: name, type: type, content: content });
        
        nameInput.value = '';
        contentArea.value = '';
        
        renderTemplates();
        saveData();
        showToast('✅ Template saved!');
    } catch (error) {
        console.error('Save template error:', error);
        showToast('Error saving template');
    }
}

function deleteTemplate(id) {
    try {
        templatesData = templatesData.filter(t => t.id !== id);
        renderTemplates();
        saveData();
        showToast('✅ Template deleted!');
    } catch (error) {
        console.error('Delete template error:', error);
        showToast('Error deleting template');
    }
}

function useTemplate(id) {
    try {
        const tmpl = templatesData.find(t => t.id === id);
        if (tmpl) {
            const cmdInput = document.getElementById('command-input');
            if (cmdInput) {
                cmdInput.value = tmpl.content;
                showToast(`Template "${tmpl.name}" inserted into the Smart Assistant input.`);
            }
        }
    } catch (error) {
        console.error('Use template error:', error);
        showToast('Error using template');
    }
}

// ===== HANDOVER FUNCTIONS =====
function renderHandover() {
    try {
        const container = document.getElementById('handover-content');
        const btn = document.getElementById('generate-handover-btn');
        if (!container) return;
        
        const allTasks = [];
        Object.values(siteData).forEach(site => {
            if (site && Array.isArray(site.tasks)) {
                allTasks.push(...site.tasks.filter(t => t.status !== 'done'));
            }
        });
        
        if (allTasks.length < 2) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">📤</div>
                    <div class="empty-state-title">Need at least 2 tasks</div>
                    <div class="empty-state-message">
                        Add more tasks to generate a handover summary for business continuity.
                    </div>
                </div>
            `;
            if (btn) btn.style.display = 'none';
            return;
        }
        
        let html = '<table style="width:100%; border-collapse: collapse; font-size:14px;">';
        html += '<tr style="text-align:left; background:#ecf0f1;">' +
                '<th style="border-bottom:1px solid #ccc; padding:4px;">Site</th>' +
                '<th style="border-bottom:1px solid #ccc; padding:4px;">Description</th>' +
                '<th style="border-bottom:1px solid #ccc; padding:4px;">Category</th>' +
                '<th style="border-bottom:1px solid #ccc; padding:4px;">Priority</th>' +
                '<th style="border-bottom:1px solid #ccc; padding:4px;">Due Date</th>' +
                '<th style="border-bottom:1px solid #ccc; padding:4px;">Time Spent</th>' +
                '</tr>';
        allTasks.forEach(task => {
            const prLabel = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
            const timeLabel = (task.timeSpent && task.timeSpent > 0) ? task.timeSpent + 'h' : 'N/A';
            html += `<tr><td style="padding:4px;">${task.site}</td><td style="padding:4px;">${task.description}</td><td style="padding:4px;">${task.category || 'General'}</td><td style="padding:4px;">${prLabel}</td><td style="padding:4px;">${task.dueDate || 'No deadline'}</td><td style="padding:4px;">${timeLabel}</td></tr>`;
        });
        html += '</table>';
        container.innerHTML = html;
        if (btn) btn.style.display = 'inline-block';
    } catch (error) {
        console.error('Render handover error:', error);
    }
}

function generateHandover() {
    try {
        const allTasks = [];
        Object.values(siteData).forEach(site => {
            if (site && Array.isArray(site.tasks)) {
                allTasks.push(...site.tasks.filter(t => t.status !== 'done'));
            }
        });
        
        if (allTasks.length < 2) {
            showToast('At least two tasks are required to generate a handover file.');
            return;
        }
        
        let html = '<html><head><meta charset="UTF-8"><style>';
        html += 'body{font-family:Arial,Helvetica,sans-serif;margin:20px;}';
        html += 'h2{color:#2c3e50;margin-bottom:20px;}';
        html += 'table{border-collapse:collapse;width:100%;}';
        html += 'th{background-color:#3498db;color:#fff;padding:8px;border:1px solid #ccc;text-align:left;}';
        html += 'td{padding:8px;border:1px solid #ccc;}';
        html += 'tr:nth-child(even){background-color:#f2f2f2;}';
        html += '</style></head><body>';
        html += '<h2>CRA Handover Report</h2>';
        html += '<table><tr><th>Site</th><th>Description</th><th>Category</th><th>Priority</th><th>Due Date</th><th>Time Spent</th></tr>';
        allTasks.forEach(task => {
            const prLabel = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
            const timeLabel = (task.timeSpent && task.timeSpent > 0) ? task.timeSpent + 'h' : 'N/A';
            html += `<tr><td>${task.site}</td><td>${task.description}</td><td>${task.category || 'General'}</td><td>${prLabel}</td><td>${task.dueDate || 'No deadline'}</td><td>${timeLabel}</td></tr>`;
        });
        html += '</table></body></html>';
        
        const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'CRA_Handover_' + new Date().toISOString().split('T')[0] + '.doc';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('✅ Handover report generated and downloaded.');
    } catch (error) {
        console.error('Generate handover error:', error);
        showToast('Error generating handover');
    }
}

// ===== MENTAL HEALTH FUNCTIONS =====
function updateMentalHealthStatus() {
    try {
        const statusEl = document.getElementById('mental-health-status');
        if (!statusEl) return;
        
        const tasks = [];
        Object.values(siteData).forEach(site => {
            if (site && Array.isArray(site.tasks)) {
                tasks.push(...site.tasks.filter(t => t.status !== 'done'));
            }
        });
        
        const count = tasks.length;
        let message;
        
        if (count <= 5) {
            message = '😊 Your workload is manageable. Stay hydrated, stretch regularly and enjoy short mindful breathing exercises.';
        } else if (count <= 10) {
            message = '😐 Workload is moderate. Schedule a 5‑minute pause to practice CBT techniques: take deep breaths, reframe negative thoughts and maintain perspective.';
        } else {
            message = '⚠️ Your workload seems high. It\'s time to take a break, talk to your team about redistributing tasks, and consider longer rest periods to prevent burnout.';
        }
        statusEl.textContent = message;
    } catch (error) {
        console.error('Mental health update error:', error);
    }
}

// ===== INITIALIZATION =====
function initializeSystem() {
    try {
        console.log('Initializing Clean CRA System...');
        
        loadData();
        removeLegacySiteElements();
        initializeSites();
        
        Object.keys(siteData).forEach(site => {
            if (siteData[site].tasks && Array.isArray(siteData[site].tasks)) {
                siteData[site].tasks.forEach(task => {
                    addToTaskList(task, site);
                    addToSiteTaskList(task, site);
                });
            }
        });
        
        updateTaskStats();
        renderTemplates();
        renderHandover();
        updateMentalHealthStatus();
        
        updateTime();
        setInterval(updateTime, 60000);
        
        const timeZoneInput = document.getElementById('timeZone');
        if (timeZoneInput) {
            timeZoneInput.addEventListener('input', function(e) {
                const inputValue = e.target.value.trim().toLowerCase();
                if (inputValue) {
                    currentTimeZone = timeZoneMap[inputValue] || inputValue;
                    updateTime();
                }
            });
        }
        
        const commandInput = document.getElementById('command-input');
        if (commandInput) {
            commandInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    processCommand();
                }
            });
        }
        
        setInterval(saveData, 30000);

        const descInput = document.getElementById('task-description');
        const categorySelect = document.getElementById('task-category');
        if (descInput && categorySelect) {
            descInput.addEventListener('blur', function() {
                const text = descInput.value.trim();
                if (text) {
                    const cls = classifyTask(text);
                    if (cls && cls.category) {
                        categorySelect.value = cls.category;
                    }
                }
            });
        }
        
        window.addEventListener('beforeunload', saveData);
        
        console.log('Clean CRA System initialized successfully!');
    } catch (error) {
        console.error('Initialization error:', error);
    }
}

// ===== GLOBAL FUNCTION EXPOSURE =====
window.showTab = showTab;
window.addTask = addTask;
window.markDone = markDone;
window.deleteTask = deleteTask;
window.editTask = editTask;
window.editVisit = editVisit;
window.addCustomSiteDynamic = addCustomSiteDynamic;
window.processCommand = processCommand;
window.resetData = resetData;
window.applySettings = applySettings;
window.saveTemplate = saveTemplate;
window.useTemplate = useTemplate;
window.deleteTemplate = deleteTemplate;
window.generateHandover = generateHandover;
window.scrollToSmartAssistant = scrollToSmartAssistant;

// ===== INITIALIZATION TRIGGERS =====
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSystem);
} else {
    initializeSystem();
}

setTimeout(initializeSystem, 1000);

document.addEventListener('DOMContentLoaded', function () {
    try {
        const saveBtn = document.getElementById('save-template-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', function (ev) {
                ev.preventDefault();
                saveTemplate();
            });
        }
    } catch (error) {
        console.error('Error binding template button:', error);
    }
});

console.log('Enhanced CRA Management System v4 - All Errors Fixed');
</script>

<footer style="text-align:center; font-size:12px; color:#888; margin-top:30px;">
  © 2025. All rights reserved.  
  <br>
  This dashboard is protected by copyright law.  
  <br>
  Unauthorized reproduction or redistribution is prohibited.
</footer>
</body>
</html>
